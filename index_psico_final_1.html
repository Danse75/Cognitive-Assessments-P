<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Evaluaciones Psicol√≥gicas Online</title>
<style>
:root{--bg:#f8fafc;--fg:#0f172a;--muted:#64748b;--card:#fff;--border:#e2e8f0;--primary:#0f172a;--pc:#fff}
*{box-sizing:border-box}body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica Neue,Arial;background:var(--bg);color:var(--fg)}
.container{max-width:960px;margin:0 auto;padding:24px}
header{display:flex;align-items:center;justify-content:space-between}
.logo{width:32px;height:32px;background:var(--primary);border-radius:14px}
h1{font-size:20px;margin:0}.subtitle,.muted{color:var(--muted);font-size:12px}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px}
.btn{border-radius:12px;border:1px solid var(--border);background:#fff;padding:10px 14px;cursor:pointer}
.btn.primary{background:var(--primary);color:var(--pc);border-color:var(--primary)}
.btn:disabled{opacity:.5;cursor:not-allowed}input,select{border:1px solid var(--border);border-radius:12px;padding:10px 12px;width:100%}
label{font-size:12px;color:var(--muted)}.row{display:grid;grid-template-columns:1fr;gap:12px}.grid{display:grid;gap:12px}
.center{display:grid;place-items:center;gap:18px}.title{font-size:18px;font-weight:600;margin:0 0 8px 0}
.big{font-size:48px;font-weight:700}.peg{position:relative;height:220px;border:1px solid var(--border);border-radius:12px;background:#fff;display:grid;place-items:end center}
.peg .pole{position:absolute;left:50%;transform:translateX(-50%);bottom:32px;width:3px;height:160px;background:#cbd5e1}
.peg .base{position:absolute;left:12px;right:12px;bottom:20px;height:6px;background:#cbd5e1;border-radius:2px}
.peg .stack{width:100%;display:flex;flex-direction:column-reverse;align-items:center;gap:6px;padding-bottom:28px}
.square{width:64px;height:64px;border:2px solid var(--primary)}.grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;width:256px;margin:0 auto}
@media(min-width:700px){.row{grid-template-columns:1fr 1fr}.grid3{width:320px;gap:14px}.square{width:72px;height:72px}}
</style>
</head>
<body>
<div class="container">
<header>
  <div style="display:flex;align-items:center;gap:10px">
    <div class="logo"></div>
    <div><h1>Evaluaciones Psicol√≥gicas Online</h1><div class="subtitle">Demo ejecutable ‚Äî sin token (Sheets conectado)</div></div>
  </div>
  <div class="subtitle" id="viewtag">START</div>
</header>

<div id="app"></div>

<footer style="margin-top:24px;border-top:1px solid var(--border);padding-top:12px" class="muted">
  Resultados se env√≠an a tu Google Sheet v√≠a Apps Script.
</footer>
</div>

<script>
(function(){
  const SHEETS_ENDPOINT = "https://script.google.com/macros/s/AKfycbyHzPBV3KCC6geog8XQHmyvPNgE0JOIBziW0KJDetUHMBZ01qhMBfZe0gRjIeHTiouN/exec";
  function sendToSheets(payload){
    try{
      if(!SHEETS_ENDPOINT) return;
      fetch(SHEETS_ENDPOINT,{method:"POST",mode:"no-cors",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
    }catch(e){ console.warn("No se pudo enviar a Sheets",e); }
  }

  const state={view:"start",participant:{name:"",idNumber:""},battery:["stroop","hanoi","corsi"],firstTask:"stroop",iTask:0,trials:[],sentOnce:false};
  const $=(s,r=document)=>r.querySelector(s);
  function el(t,p={},...cs){const n=document.createElement(t);for(const[k,v] of Object.entries(p||{})){if(k==="class")n.className=v;else if(k.startsWith("on")&&typeof v==="function")n.addEventListener(k.slice(2).toLowerCase(),v);else if(k==="html")n.innerHTML=v;else n.setAttribute(k,v);}for(const c of cs){if(c!=null)n.appendChild(typeof c==="string"?document.createTextNode(c):c);}return n}
  function download(fn,txt){const a=el("a",{href:"data:application/json;charset=utf-8,"+encodeURIComponent(txt),download:fn,style:"display:none"});document.body.appendChild(a);a.click();a.remove()}
  function accuracy(ts){const v=ts.filter(t=>t.correct!==undefined);return v.length?v.filter(t=>!!t.correct).length/v.length:0}
  function meanRt(ts){const v=ts.map(t=>t.rtMs).filter(x=>typeof x==="number"&&isFinite(x));return v.length?Math.round(v.reduce((a,b)=>a+b,0)/v.length):null}
  function setView(v){state.view=v;$("#viewtag").textContent=v.toUpperCase();render()}

  function ViewStart(){
    return el("section",{},
      el("div",{class:"title"},"Inicio"),
      el("p",{class:"muted"},"Completar√°s todas las pruebas. Elige con cu√°l deseas empezar e ingresa tus datos."),
      el("div",{class:"card grid"},
        el("div",{class:"grid"},el("label",{},"Nombres y apellidos"),el("input",{value:state.participant.name,oninput:e=>state.participant.name=e.target.value,placeholder:"Nombres y apellidos"})),
        el("div",{class:"grid"},el("label",{},"ID (c√©dula / ID number)"),el("input",{value:state.participant.idNumber,oninput:e=>state.participant.idNumber=e.target.value,placeholder:"ID"})),
        el("div",{class:"grid"},
          el("label",{},"Primera prueba"),
          el("select",{onchange:e=>state.firstTask=e.target.value},
            el("option",{value:"stroop",selected:state.firstTask==="stroop"},"Stroop (interferencia)"),
            el("option",{value:"hanoi",selected:state.firstTask==="hanoi"},"Torre de Hanoi (planificaci√≥n)"),
            el("option",{value:"corsi",selected:state.firstTask==="corsi"},"Corsi 3√ó3 (memoria visoespacial)")
          )
        ),
        el("div",{},el("button",{class:"btn primary",onclick:begin},"Continuar")),
        el("ul",{class:"muted"},el("li",{},"Secuencia: Consentimiento ‚Üí Chequeo ‚Üí Tareas ‚Üí Informe"),el("li",{},"Compatible teclado y pantalla t√°ctil"))
      )
    );
  }
  function begin(){
    if(!state.participant.name.trim()||!state.participant.idNumber.trim()){alert("Ingresa nombre e ID.");return;}
    const all=["stroop","hanoi","corsi"]; state.battery=[state.firstTask,...all.filter(k=>k!==state.firstTask)]; setView("consent");
  }
  function ViewConsent(){
    let ok=false; const chk=el("input",{type:"checkbox",onchange:e=>ok=e.target.checked});
    return el("section",{},
      el("div",{class:"title"},"Consentimiento informado"),
      el("div",{class:"card"},
        el("p",{},el("b",{},"Prop√≥sito:")," evaluar funciones cognitivas (atenci√≥n, planificaci√≥n, memoria de trabajo) mediante tareas breves en l√≠nea."),
        el("p",{},el("b",{},"Duraci√≥n:")," 8‚Äì12 minutos. Puede tomar descansos si lo necesita."),
        el("p",{},el("b",{},"Riesgos:")," m√≠nimos (fatiga/aburrimiento)."),
        el("p",{},el("b",{},"Datos:")," se recogen tiempos de reacci√≥n, aciertos/errores y metadatos t√©cnicos. No se almacena informaci√≥n personal en esta demo."),
        el("p",{},el("b",{},"Voluntariedad:")," puede abandonar en cualquier momento sin consecuencias.")
      ),
      el("label",{class:"muted"},chk," He le√≠do y acepto participar. Estoy en un entorno tranquilo y sin distracciones."),
      el("div",{class:"row"},
        el("button",{class:"btn",onclick:()=>setView("start")},"Cancelar"),
        el("button",{id:"btn-accept",class:"btn primary",onclick:()=>ok&&setView("check"),disabled:true},"Continuar")
      ),
      el("script",{html:`(function(){var c=document.currentScript.parentElement.querySelector('input[type=checkbox]');var b=document.currentScript.parentElement.querySelector('#btn-accept');c.addEventListener('change',function(){b.disabled=!c.checked;});})();`})
    );
  }
  function ViewCheck(){
    const ok={screen:false,focus:true,key:false};
    const check=()=>{ok.screen=(innerWidth>=360&&innerHeight>=480);update()};
    const onVis=()=>{ok.focus=!document.hidden;update()};
    const onKey=e=>{if(e.code==="Space"){ok.key=true;update()}};
    addEventListener("resize",check); document.addEventListener("visibilitychange",onVis); addEventListener("keydown",onKey); check();
    function ready(){return ok.screen&&ok.focus}
    function go(){removeEventListener("resize",check);document.removeEventListener("visibilitychange",onVis);removeEventListener("keydown",onKey);setView("run")}
    const box=el("section",{},
      el("div",{class:"title"},"Chequeo de dispositivo"),
      el("ul",{},
        el("li",{},"üì± Tama√±o de pantalla: ",el("span",{id:"chk-screen"},"...")),
        el("li",{},"ü™ü Ventana activa: ",el("span",{id:"chk-focus"},"...")),
        el("li",{},"‚å®Ô∏è Teclado: ",el("span",{id:"chk-key"},"Pulsa barra espaciadora para probar"))
      ),
      el("button",{id:"btn-start",class:"btn primary",onclick:go,disabled:true},"Comenzar evaluaci√≥n")
    );
    function update(){ $("#chk-screen",box).textContent=ok.screen?"OK":"Muy peque√±o"; $("#chk-focus",box).textContent=ok.focus?"OK":"Volviste desde otra pesta√±a"; $("#chk-key",box).textContent=ok.key?"Barra espaciadora detectada":"Pulsa barra espaciadora para probar"; $("#btn-start",box).disabled=!ready(); }
    update(); return box;
  }
  function ViewRunner(){
    const key=state.battery[0]; // simplificado: ejecuta en orden ya configurado
    state.battery=state.battery.slice(1);
    const view=el("section",{},el("div",{class:"muted"},"Tarea en curso"),el("div",{id:"taskbox",class:"card"},"Cargando..."));
    const mount=view.querySelector("#taskbox");
    function done(){ if(state.battery.length){ render(); } else { setView("report"); }}
    if(key==="stroop") TaskStroop(mount,done); else if(key==="hanoi") TaskHanoi(mount,done); else if(key==="corsi") TaskCorsi(mount,done);
    return view;
  }
  function ViewReport(){
    const by={}; for(const t of state.trials){(by[t.task]=by[t.task]||[]).push(t)}
    const scores=Object.entries(by).map(([task,arr])=>({task,acc:accuracy(arr),rt:meanRt(arr)}));
    const payload={participant:state.participant,completedAt:new Date().toISOString(),scores,trials:state.trials};
    sendToSheets(payload); window.__lastPayload=payload;
    const byTask={}; for(const t of payload.trials){(byTask[t.task]=byTask[t.task]||[]).push(t)}
    const sec=el("section",{},
      el("div",{class:"title"},"Informe de resultados"),
      el("div",{class:"muted"},(payload.participant.name||"Participante")+" ¬∑ ID: "+(payload.participant.idNumber||"‚Äî")+" ¬∑ "+new Date(payload.completedAt).toLocaleString()),
      ...payload.scores.map(s=>el("div",{class:"card"},
        el("div",{class:"title"},s.task.toUpperCase()),
        el("div",{},"Exactitud: "+Math.round(s.acc*100)+"%"),
        el("div",{},"RT medio: "+(s.rt==null?"‚Äî":s.rt+" ms")),
        el("details",{},el("summary",{},"Ver ensayos ("+((byTask[s.task]||[]).length)+")"),
          el("div",{style:"max-height:192px;overflow:auto;margin-top:6px"},
            el("table",{style:"width:100%;border-collapse:collapse;font-size:12px"},
              el("thead",{},el("tr",{},el("th",{},"#"),el("th",{},"Stim"),el("th",{},"Resp"),el("th",{},"‚úî"),el("th",{class:"right"},"RT"))),
              el("tbody",{},...(byTask[s.task]||[]).map((t,i)=>el("tr",{style:"border-top:1px solid var(--border)"},
                el("td",{},t.index),
                el("td",{},el("code",{class:"small"},JSON.stringify(t.stimulus))),
                el("td",{},el("code",{class:"small"},JSON.stringify(t.response))),
                el("td",{},t.correct?"‚úî":"‚úñ"),
                el("td",{class:"right"},t.rtMs==null?"‚Äî":t.rtMs)
              )))
            )
          )
        )
      )),
      el("div",{class:"row"},
        el("button",{class:"btn",onclick:()=>print()},"Imprimir / PDF"),
        el("button",{class:"btn primary",onclick:()=>download("informe_"+(state.participant.idNumber||"anon")+".json",JSON.stringify(payload,null,2))},"Exportar JSON"),
        el("button",{class:"btn",onclick:()=>{state.trials=[];setView('start')}},"Nueva evaluaci√≥n")
      ),
      el("div",{class:"muted"},"* Los resultados ya se enviaron a Google Sheets.")
    ); return sec;
  }

  // Tareas ------------------------------
  function TaskStroop(mount,done){
    const COLORS=[{name:"ROJO",css:"color:#dc2626",key:"R"},{name:"AZUL",css:"color:#2563eb",key:"A"},{name:"VERDE",css:"color:#16a34a",key:"V"},{name:"AMARILLO",css:"color:#ca8a04",key:"M"}];
    let trial=0,stim=null,t0=0;
    function pick(a){return a[Math.floor(Math.random()*a.length)]}
    function next(){ if(trial>=24){done();return} const word=pick(COLORS),ink=pick(COLORS); stim={word,ink}; t0=performance.now(); render(); }
    function respond(sel){ if(!stim)return; const rt=Math.round(performance.now()-t0); const correct=sel.key===stim.ink.key; state.trials.push({task:"stroop",index:trial,stimulus:{word:stim.word.name,ink:stim.ink.name},response:{key:sel.key},correct,rtMs:rt}); trial++; next(); }
    function render(){ mount.innerHTML=""; mount.appendChild(el("div",{class:"center"}, el("div",{class:"muted"},"Pulsa el ",el("b",{},"color de la tinta")," (24 ensayos)"), stim?el("div",{class:"big",style:stim.ink.css},stim.word.name):el("div",{},"‚Äî"), el("div",{},...COLORS.map(c=>el("button",{class:"btn",onclick:()=>respond(c)},c.name))) )); }
    next();
  }
  function TaskHanoi(mount,done){
    const N=3; let pegs=[Array.from({length:N},(_,i)=>N-i),[],[]]; let sel=null,moveIdx=0,tMove=performance.now();
    function top(a){return a[a.length-1]} function canPlace(d,t){const topd=top(t);return topd===undefined||topd>d} function complete(){return pegs[2].length===N}
    function click(pi){ if(sel===null){ if(pegs[pi].length===0)return; sel=pi; render(); return; } if(sel===pi){sel=null;render();return}
      const from=sel,to=pi,src=pegs[from]; if(src.length===0){sel=null;render();return} const disc=top(src); const valid=canPlace(disc,pegs[to]); const rt=Math.round(performance.now()-tMove); tMove=performance.now();
      state.trials.push({task:"hanoi",index:moveIdx++,stimulus:{from,to,disc,state:JSON.parse(JSON.stringify(pegs))},response:{move:[from,to]},correct:valid,rtMs:rt});
      if(!valid){sel=null;render();return} pegs=pegs.map(a=>a.slice()); pegs[from].pop(); pegs[to].push(disc); sel=null; render(); if(complete()) setTimeout(done,250);
    }
    function render(){ mount.innerHTML=""; const grid=el("div",{class:"grid",html:'<div class="muted">Mueve todos los discos a la <b>tercera torre</b>. No coloques un disco grande sobre uno peque√±o.</div>'}); const row=el("div",{class:"row"});
      for(let pi=0;pi<3;pi++){ const pegEl=el("button",{class:"peg"+(sel===pi?" ring":""),title:"Torre "+(pi+1),onclick:()=>click(pi)}, el("div",{class:"pole"}), el("div",{class:"base"}), el("div",{class:"stack"}) ); const stack=pegEl.querySelector(".stack");
        pegs[pi].forEach((d,idx)=>{ const disc=el("div",{style:"height:22px;width:"+ (40+d*15) +"%;background:"+["#334155","#475569","#64748b","#94a3b8"][d%4]+";color:#fff;border-radius:6px;display:grid;place-items:center;font-size:10px"}, String(d)); stack.appendChild(disc); });
        row.appendChild(pegEl);
      }
      grid.appendChild(row); grid.appendChild(el("div",{class:"center muted"},"Selecciona ",el("b",{},"origen")," y luego ",el("b",{},"destino"),". Discos: "+N)); mount.appendChild(grid);
    }
    render();
  }
  function TaskCorsi(mount,done){
    let trial=0,phase="show",seq=[],flash=null,resp=[],timer=null;
    function shuffle(a){return a.map(v=>[Math.random(),v]).sort((x,y)=>x[0]-y[0]).map(x=>x[1])}
    function pickSeq(len){const cells=Array.from({length:9},(_,i)=>i);return shuffle(cells).slice(0,len)}
    function next(){ if(trial>=9){done();return} const len=3+Math.floor(trial/3); seq=pickSeq(len); resp=[]; phase="show"; let i=0; render(); timer=setInterval(()=>{flash=seq[i];i++;render(); if(i>=seq.length){clearInterval(timer); setTimeout(()=>{flash=null;phase="input";render()},600)}},700); }
    function press(i){ if(phase!=="input")return; resp=resp.concat(i); render(); if(resp.length===seq.length){ const correct=JSON.stringify(resp)===JSON.stringify(seq); state.trials.push({task:"corsi",index:trial,stimulus:{seq},response:{seq:resp},correct,rtMs:null}); phase="pause"; setTimeout(()=>{trial++;next()},700); } }
    function render(){ mount.innerHTML=""; const title=el("div",{class:"muted"},"Repite la secuencia tocando los cuadros en el ",el("b",{},"mismo orden"),". (9 ensayos)"); const grid=el("div",{class:"grid3"}); for(let i=0;i<9;i++){ grid.appendChild(el("button",{class:"square",style:(flash===i?"background:#0f172a;color:#fff;":"background:#fff;"),onclick:()=>press(i)})); } const foot=el("div",{class:"center muted"},"Ensayo "+(trial+1)+" / 9"); mount.appendChild(el("div",{class:"center"},title,grid,foot)); }
    next();
  }

  function render(){ const root=$("#app"); root.innerHTML=""; let v=null; if(state.view==="start") v=ViewStart(); else if(state.view==="consent") v=ViewConsent(); else if(state.view==="check") v=ViewCheck(); else if(state.view==="run") v=ViewRunner(); else if(state.view==="report") v=ViewReport(); root.appendChild(v); }
  render();
})();
</script>
</body>
</html>
